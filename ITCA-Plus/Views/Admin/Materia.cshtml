
@{
    ViewBag.Title = "Materia";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model ITCA_Plus.Models.Materia

@section Scripts {
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/jqueryval")
}
<script>
    //FALTA ELIMINAR Y CANCELAR

    // Función para cancelar edición
    function cancelarEdicion() {
    // Limpiar campos
    $('#id').val('');
    $('#nombre').val('');
    $('#formCrear').removeClass('was-validated');
    $('#formCrear')[0].reset();

    // Mostrar/Ocultar botones
    $('#Actualizar').hide();
    $('#Agregar').show();
    $('#cancelar').hide();

    // Limpiar validaciones de Html.ValidationMessageFor
    var spanError = document.querySelector('[data-valmsg-for="nombre"]');

    if (spanError) {
        // Limpiar el texto del mensaje
        spanError.innerHTML = '';

        // Cambiar la clase a "field-validation-valid"
        spanError.classList.remove('field-validation-error');
        spanError.classList.add('field-validation-valid');
    }
}


    // Editar materia (cargar datos al form)
    function editarMateria(id, nombre) {
        $('#id').val(id);
        $('#nombre').val(nombre);
        $('#Actualizar').show();
        $('#Agregar').hide();
        $('#cancelar').show();

        // Limpiar validaciones de Html.ValidationMessageFor
        var spanError = document.querySelector('[data-valmsg-for="nombre"]');

        if (spanError) {
            // Limpiar el texto del mensaje
            spanError.innerHTML = '';

            // Cambiar la clase a "field-validation-valid"
            spanError.classList.remove('field-validation-error');
            spanError.classList.add('field-validation-valid');
        }
    }

    function loadMaterias() {
    $.ajax({
        url: '@Url.Action("listaMaterias", "Admin")',
        type: 'GET',
        dataType: 'json',
        success: function (data) {
            if (data.success && data.materias.length > 0) {
                var html = '';
                data.materias.forEach(materia => {
                    html += '<tr>';
                    html += '<td>' + materia.id + '</td>';
                    html += '<td>' + materia.nombre + '</td>';
                    html += '<td><button class="btn btn-sm me-2" onclick="editarMateria(' + materia.id + ', \'' + materia.nombre + '\')"><i class="fa-solid fa-pen fa-lg text-warning"></i></button><button class="btn btn-sm" onclick="eliminarMateria(' + materia.id + ')"> <i class="fa-solid fa-trash fa-lg text-danger"></i></button></td>';
                    html += '</tr>';
                });
                $('#tablaMaterias').html(html);
            } else {
                $('#tablaMaterias').html('<tr><td colspan="4" class="text-center">No hay materias registradas</td></tr>');
            }
        },
        error: function () {
            Swal.fire('Error', 'No se pudo cargar la lista de materias.', 'error');
        }
    });
}

    // Eliminar materia
    function eliminarMateria(id) {
        Swal.fire({
            title: '¿Seguro que quieres eliminar?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                $.post('@Url.Action("Eliminar", "Admin")', { id: id }, function (response) {
                    if (response.success) {
                        Swal.fire('Eliminado', response.message, 'success');
                        loadMaterias();
                    } else {
                        Swal.fire('Error', response.message, 'error');
                    }
                });
            }
        });
    }

    $(document).ready(function () {


        $('#Actualizar').hide();
        $('#cancelar').hide();
        loadMaterias();

        document.getElementById('cancelar').addEventListener('click', function () {
            cancelarEdicion();
        });




         // Guardar (Agregar / Editar)
        $('#formCrear').on('submit', function (e) {
            e.preventDefault();
            var form = this;

            form.classList.add('was-validated');

            if (form.checkValidity() === false) {
                return;
            }


            var isUpdate = $('#Actualizar').is(':visible');

            var formData = $(form).serialize();
            //var id = $('#id').val();

            var url = isUpdate ? '@Url.Action("Actualizar", "Admin")' : '@Url.Action("Crear", "Admin")';

            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                success: function (response) {
                    if (response.success) {
                        Swal.fire('Éxito', response.message, 'success');
                        form.reset();
                        form.classList.remove('was-validated');
                        $('#Actualizar').hide();
                        $('#Agregar').show();
                        loadMaterias();
                    } else {
                        Swal.fire('Error', response.message, 'error');
                    }
                }
            });
        });

    });


</script>

<h2>Gestión de Materias</h2>
<main class="container py-5">
    <div class="row">
        <div class="col-12 col-md-8 col-lg-6">
            <form id="formCrear" class="needs-validation" novalidate>           
                <div class="input-group">
                    @Html.TextBoxFor(m => m.nombre, new { @class = "form-control", placeholder = "Nombre de la Materia", required = "required" })
                    <button class="btn btn-success" type="submit" id="Agregar">Agregar</button>
                    <button class="btn btn-warning" type="submit" id="Actualizar">Actualizar</button>
                    <button class="btn btn-primary" type="button" id="cancelar">Cancelar</button>
                </div>
                @Html.ValidationMessageFor(m => m.nombre, "", new { @class = "text-danger small" })
                @Html.HiddenFor(m => m.id)
            </form>
        </div>
    </div>

    <div class="table-responsive mt-3">
        <table class="table">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaMaterias" class="table-group-divider">
            </tbody>
        </table>
    </div>
</main>